<?
require($_SERVER["DOCUMENT_ROOT"]."/bitrix/header.php");
$APPLICATION->SetPageProperty("description", "Luxury Travel Mart - the leading luxury travel exhibition");
$APPLICATION->SetPageProperty("title", "Luxury Travel Mart");
$APPLICATION->SetPageProperty("NOT_SHOW_NAV_CHAIN", "Y");
$APPLICATION->SetTitle("THE LEADING LUXURY TRAVEL EXHIBITION");
global $USER;

?>



<? if ($USER->isAdmin()) {?>
    
<?

if ($_REQUEST["go"]) {
    
    if (!$_REQUEST["message"]) $error[] = "Message field required.";
    if (!$_REQUEST["company"]) $error[] = "Company field required.";
    if (!$_REQUEST["TO_USER"] AND !$_REQUEST["to_all"]) $error[] = "To user or to all field required.";
    
    if (empty($error)) {
        global $DB;
        
        $q = "INSERT INTO  `chat_admin_messages` (`ID`,`AUTHOR_ID`,`TO_USER`,`MESSAGE`,`COMPANY`,`DATE_CREATE`,`DELIVERED`) VALUES (NULL,'1','".$_REQUEST["TO_USER"]."','".strip_tags(iconv("UTF-8","CP1251",$_REQUEST["message"]))."','".strip_tags(iconv("UTF-8","CP1251",$_REQUEST["company"]))."','".date("Y-m-d H:i:s", time())."','1')";
		$res = $DB->Query($q, false, $err_mess.__LINE__);
		
		
		if ($res->result) {
		    LocalRedirect("new.php?exhb=".$_REQUEST["exhb"]."&success=Your message have been sent.");
		}
		
        
        
    }
    
}


$filter = Array();
$rsUsers = CUser::GetList(($by="work_company"), ($order="asc"), $filter);
while ($arUsers = $rsUsers->GetNext()) {
    if ($arUsers["WORK_COMPANY"])
        $companies[trim($arUsers["WORK_COMPANY"])] = trim($arUsers["WORK_COMPANY"]);
}
?>
    
    
    
    <div class="admin_block">
        <div class="helper_nav">
            <a href="/administrator/messages/?exhb=<?=$_REQUEST["exhb"]?>">Inbox</a>
            <a href="/administrator/messages/sent.php?exhb=<?=$_REQUEST["exhb"]?>">Sent</a>
            <a href="/administrator/messages/new.php?exhb=<?=$_REQUEST["exhb"]?>" class="selected">New message or notice</a>
        </div>
        
        <div class="form_holder">
        
<? if ($_REQUEST["success"]) {?><div class="green"><?=$_REQUEST["success"]?></div><?}?>
<? if ($_REQUEST["go"] AND !empty($error)) {?><div class="red"><?=implode("<br>",$error)?></div><?}?>
        
            <form action="<?=$_SERVER["PHP_SELF"]?>" method="post">
            <input type="hidden" name="exhb" value="<?=$_REQUEST["exhb"]?>" >
                <table class="sent_mess_table">
                    <tr>
                        <td class="sent_mess_table_col1">
                            <div class="select_wrap">
                                <span>Company:</span>
                                <select name="company" id="company" onchange="loadUser($('#company option:selected').val());">
                                    <option value=""> -- Select -- </option>
                                    <? foreach ($companies as $company) {?>
                                        <option value="<?=urlencode($company)?>" <? if ($_REQUEST["company"]==urlencode($company)) {?>selected="selected"<?}?>><?=$company?></option>
                                    <?}?>
                                </select>
                            </div>
                            <div class="select_wrap">
                                <span>To:</span>
                                <select name="TO_USER" id="TO_USER">
                                    <option value=""> -- Select -- </option>
                                    <? if ($_REQUEST["company"]) {?>
<?
$filter = Array("WORK_COMPANY"=>(urldecode($_REQUEST["company"])));
$rsUsers = CUser::GetList(($by="UF_FIO"), ($order="asc"), $filter, array("SELECT"=>array("UF_*")));
while ($arUsers = $rsUsers->GetNext()) {
?>
   <option value="<?=$arUsers["ID"]?>" <? if ($_REQUEST["TO_USER"]==$arUsers["ID"]) {?>selected="selected"<?}?>><?=$arUsers["UF_FIO"]?></option>
<?}?> 
                                    <?}?>
                                </select>
                            </div>
                        </td>
                        <td class="sent_mess_table_col2">
                            <input type="checkbox" name="to_all" value="1" <? if ($_REQUEST["to_all"]) {?>checked="checked"<?}?> /> SEND NOTICE TO EVERYONE
                        </td>
                    </tr>
                </table>
                <div class="message">
                    <textarea name="message"><?=$_REQUEST["message"]?></textarea>
                </div>
                <div class="submit"><input type="submit" name="go" value="Send" /></div>
            </form>
        </div>
        
    <script type="text/javascript">
        function loadUser(id) {
            $.ajax({ 
                url: 'contacts_ajax.php?comp='+id, 
                success: function(data) { 
                    $('#TO_USER').empty().html(data);
                },
                error: function(msg) { }
            });
        }
    </script>
    
    
    </div>
    
<?}else{?>

<?$APPLICATION->IncludeComponent(
	"btm:user.login",
	"",
	Array(
		"REGISTER_URL" => "",
		"GUEST_URL" => "",
		"PARTICIP_URL" => "",
		"ADMIN_URL" => "",
		"SHOW_ERRORS" => "N"
	),
false
);?>

<?}?>



<?require($_SERVER["DOCUMENT_ROOT"]."/bitrix/footer.php");?>